import{S as q,g as z,A as D}from"./index-DxIEM6f5.js";let d,T=null;async function P(e,t=[]){if(T=Number(e),!window.io){console.error("Socket.io client not loaded");return}d=window.io(q,{reconnection:!0,reconnectionAttempts:1/0,reconnectionDelay:500,reconnectionDelayMax:5e3,timeout:2e4}),console.log("[SOCKET] Inicializando socket para userId:",T,"chatIds:",t),d.on("connect",()=>{console.log("[SOCKET] ConexiÃ³n establecida:",d.id),d.emit("joinChats",{userId:T,chatIds:t})}),d.on("disconnect",n=>{console.warn("[SOCKET] Desconectado:",n)}),d.io.on("reconnect_attempt",n=>{console.log("[SOCKET] Intento de reconexiÃ³n #"+n)}),d.io.on("reconnect",n=>{console.log("[SOCKET] Reconexion exitosa tras intentos:",n),d.emit("joinChats",{userId:T,chatIds:t})}),d.io.on("reconnect_failed",()=>{console.error("[SOCKET] ReconexiÃ³n fallida definitivamente.")}),d.on("new_message",n=>{typeof window.onNewMessage=="function"&&window.onNewMessage(n)}),d.on("typing",({userId:n})=>{typeof window.onTyping=="function"&&window.onTyping(n)}),d.on("user_online",n=>{typeof window.onUserOnline=="function"&&window.onUserOnline(n)}),d.on("user_offline",n=>{typeof window.onUserOffline=="function"&&window.onUserOffline(n)}),d.on("online_users",n=>{Array.isArray(n)&&(window.onlineUsers=n.map(r=>Number(r)),typeof window.refreshOnlineUsers=="function"&&window.refreshOnlineUsers())})}function B(e){d&&e&&d.emit("joinChat",{chatId:e})}function K(e){d&&e&&d.emit("typing",{chatId:e,userId:T})}const w=D+"/api";console.log("chats.script.js ejecutÃ¡ndose");let h=null,o=null,l=null,S=null,y=!1;const v=new Map,_=document.getElementById("user-list"),f=document.getElementById("chat-messages"),I=document.getElementById("chat-input"),x=document.getElementById("send-btn"),N=document.getElementById("typing-indicator"),F=new Map;async function U(e=!0){const t=e&&o?o.user_id:null,n=localStorage.getItem("token");let r=[];try{r=await(await fetch(`${w}/chat/conversations`,{headers:{Authorization:`Bearer ${n}`}})).json()}catch(i){console.error("Error obteniendo conversaciones:",i)}if(Array.isArray(r)||(r=[]),!_)return;if(_.innerHTML="",!(r.length>0)){const i=document.createElement("div");i.className="no-conv-msg",i.textContent="No hay conversaciones todavÃ­a",_.appendChild(i)}window.lastConversations=r,r.forEach(i=>{const p=i.chatId||i.chat_id,{otherUser:s,lastMessage:c,unreadCount:u}=i;s&&F.set(p,s.user_id);const m=document.createElement("div");m.className="conversation-item",m.dataset.chatId=p,m.dataset.uid=s?s.user_id:"";const C=s&&s.profile_photo||"./src/images/default-avatar.png",M=window.onlineUsers&&s?window.onlineUsers.includes(s.user_id)?"ðŸŸ¢":"âšª":"",$=c?new Date(c.sent_date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",E=c?c.content:"",O=E.length>40?E.slice(0,37)+"â€¦":E;m.innerHTML=`
            <img src="${C}" alt="${s?s.first_name:""}" class="conv-avatar" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
            <div class="conv-main">
               <div class="conv-top"><span class="conv-name">${s?s.first_name+" "+s.last_name:"Desconocido"}</span><span class="conv-time">${$}</span></div>
               <div class="conv-bottom"><span class="conv-last">${O}</span>${u?`<span class="unread-badge">${u}</span>`:""}</div>
            </div>
            <span class="conv-status">${M}</span>
        `,m.onclick=()=>J(i),t&&s&&s.user_id===t&&m.classList.add("active"),_.appendChild(m)});try{S||(S=await(await fetch(`${w}/chat/users`,{headers:{Authorization:`Bearer ${n}`}})).json(),Array.isArray(S)||(S=[]));const i=new Set(r.map(s=>s.otherUser?s.otherUser.user_id:null).filter(Boolean)),p=S.filter(s=>!i.has(s.user_id));if(p.length){const s=document.createElement("div");s.className="conv-separator",s.textContent="Usuarios",_.appendChild(s),p.forEach(c=>{const u=document.createElement("div");u.className="conversation-item new-user",u.dataset.uid=c.user_id;const m=c.profile_photo||"./src/images/default-avatar.png",C=window.onlineUsers&&window.onlineUsers.includes(c.user_id)?"ðŸŸ¢":"âšª";u.innerHTML=`
                  <img src="${m}" alt="${c.first_name}" class="conv-avatar" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
                  <div class="conv-main">
                     <div class="conv-top"><span class="conv-name">${c.first_name} ${c.last_name}</span><span class="conv-time"></span></div>
                     <div class="conv-bottom"><span class="conv-last">Iniciar conversaciÃ³n</span></div>
                  </div>
                  <span class="conv-status">${C}</span>`,u.onclick=()=>L(c,null),_.appendChild(u)})}}catch(i){console.error("Error listando usuarios sin conversaciÃ³n:",i)}j()}function J(e){if(!e)return;const t=e.chatId||e.chat_id,{otherUser:n}=e;n&&L(n,t)}window.onUserOnline=e=>{if(e=Number(e),Array.isArray(window.onlineUsers)||(window.onlineUsers=[]),window.onlineUsers.includes(e)||window.onlineUsers.push(e),console.log("[ONLINE] user_online recibido",e,"lista:",window.onlineUsers),o&&o.user_id===e){const t=document.querySelector(".chat-user-info");t&&(t.querySelector("p").textContent="ðŸŸ¢ Online")}U()};window.onUserOffline=e=>{if(e=Number(e),window.onlineUsers=(window.onlineUsers||[]).filter(t=>t!==e),console.log("[ONLINE] user_offline recibido",e,"lista:",window.onlineUsers),o&&o.user_id===e){const t=document.querySelector(".chat-user-info");t&&(t.querySelector("p").textContent="âšª Offline")}U()};window.refreshOnlineUsers=()=>{U(),j()};function j(){if(!o)return;const e=document.querySelector(".chat-user-info");if(!e)return;const t=(window.onlineUsers||[]).includes(Number(o.user_id))?"ðŸŸ¢ Online":"âšª Offline";e.innerHTML=`<h3>${o.first_name} ${o.last_name}</h3><p>${t}</p>`}async function L(e,t=null){o=e,y=!1,b(!1);const n=document.querySelector(".chat-user-info"),r=document.querySelector(".chat-user-avatar"),a=e.profile_photo||e.Profile?.profile_photo||"./src/images/default-avatar.png";r&&(r.innerHTML=`<img src="${a}" alt="${e.first_name}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;">`);let i=window.onlineUsers&&window.onlineUsers.includes(e.user_id)?"ðŸŸ¢ Online":"âšª Offline";n&&(n.innerHTML=`<h3>${e.first_name} ${e.last_name}</h3><p>${i}</p>`),t?(l=t,y=!0,b(!0)):await W(h.user_id,e.user_id),y&&l&&(B(l),await G(e),R(l))}async function W(e,t){l=null,y=!1,b(!1);const n=localStorage.getItem("token");try{const a=await(await fetch(`${w}/chat/ensure`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({fromUserId:e,toUserId:t})})).json();if(a.chatId)l=a.chatId,y=!0,b(!0);else throw new Error("No se pudo obtener chatId")}catch(r){alert("Error asegurando el chat: "+(r.message||r)),y=!1,b(!1)}}async function G(e=o){if(!e)return;const t=localStorage.getItem("token");let n=v.get(e.user_id);if(!n){const a=await(await fetch(`${w}/chat/messages/${e.user_id}?limit=30`,{headers:{Authorization:`Bearer ${t}`}})).json(),i=Array.isArray(a)?a:a.messages||[];n={messages:i,hasMore:Array.isArray(a)?!1:a.hasMore,oldestTs:i.length?i[0].sent_date:null,chatId:Array.isArray(a)?null:a.chatId,otherUser:Array.isArray(a)?null:a.otherUser},v.set(e.user_id,n)}A(n,e.user_id),l=n.chatId||l,l&&H(l)}x.onclick=async()=>{const e=I.value.trim();if(!(!e||!o)){if(!y||!l){alert("No se puede enviar el mensaje: chatId no disponible");return}try{const t=localStorage.getItem("token"),r=await(await fetch(`${w}/chat/messages`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({toUserId:o.user_id,content:e})})).json();let a=v.get(o.user_id);a||(a={messages:[],hasMore:!1,oldestTs:null,chatId:l,otherUser:{first_name:o.first_name,last_name:o.last_name,profile_photo:o.profile_photo}},v.set(o.user_id,a)),a.messages.push(r),A(a,o.user_id,!0),U()}catch(t){alert("Error enviando el mensaje: "+(t.message||t))}I.value=""}};function b(e){x.disabled=!e,I.disabled=!e}I.oninput=()=>{l&&K(l)};window.onlineUsers=[];window.onNewMessage=e=>{if(console.log("[FRONT] onNewMessage:",e,"selectedUser:",o,"currentUser:",h,"currentChatId:",l),e.chat_id&&e.chat_id!==l&&(l=e.chat_id,B(l)),o&&(e.user_id===o.user_id||e.user_id===h.user_id)){let t=v.get(o.user_id);t||(t={messages:[],hasMore:!1,oldestTs:null,chatId:e.chat_id,otherUser:{first_name:o.first_name,last_name:o.last_name,profile_photo:o.profile_photo}},v.set(o.user_id,t)),t.messages.find(n=>n.message_id===e.message_id&&e.message_id)||t.messages.push(e),A(t,o.user_id,!0),H(l),R(l)}U()};window.onTyping=e=>{!o||e!==o.user_id||N&&(N.style.display="block",clearTimeout(window._typingTimeout),window._typingTimeout=setTimeout(()=>{N.style.display="none"},1500))};(async()=>{h=await z(),console.log("[FRONT] currentUser:",h);let e=null;if(h&&h.User&&typeof h.User.user_id<"u"?e=h.User.user_id:h&&typeof h.user_id<"u"&&(e=h.user_id),e==null){console.error("[FRONT][CHAT] No se pudo determinar userId. Abortando initChatSocket.");return}const t=localStorage.getItem("token");let n=[];try{n=(await(await fetch(`${w}/chat/ids`,{headers:{Authorization:`Bearer ${t}`}})).json()).chatIds||[]}catch(r){console.error("Error obteniendo chat ids:",r)}P(e,n),U()})();function A(e,t,n=!1){const{messages:r,otherUser:a}=e,i=Math.abs(f.scrollHeight-f.scrollTop-f.clientHeight)<50;if(n){if(!f.querySelector(".load-more-btn")&&e.hasMore){const c=document.createElement("button");c.textContent="Cargar mÃ¡s",c.className="load-more-btn",c.onclick=()=>k(t),f.insertBefore(c,f.firstChild)}}else if(f.innerHTML="",e.hasMore){const s=document.createElement("button");s.textContent="Cargar mÃ¡s",s.className="load-more-btn",s.onclick=()=>k(t),f.appendChild(s)}const p=document.createDocumentFragment();r.forEach(s=>{if(f.querySelector(`[data-mid="${s.message_id}"]`))return;const c=s.user_id===h.user_id,u=document.createElement("div");u.dataset.mid=s.message_id||`${s.chat_id}-${s.sent_date}-${s.user_id}`,u.className="msg-row "+(c?"sent":"received");const m=document.createElement("div");m.className="message "+(c?"sent":"received");const C=new Date(s.sent_date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),M=c?s.read_at?'<span class="tick-read">âœ“âœ“</span>':'<span class="tick-delivered">âœ“</span>':"",$=c?"TÃº":a?a.first_name:"",E=a&&a.profile_photo?a.profile_photo:"./src/images/default-avatar.png",O=h.profile_photo||h.Profile?.profile_photo||"./src/images/default-avatar.png";if(m.innerHTML=`<span class="msg-content"><strong>${$?$+": ":""}</strong>${s.content}</span><span class="msg-meta">${C} ${M}</span>`,c){const g=document.createElement("img");g.src=O,g.alt="TÃº",g.className="msg-avatar self",u.appendChild(m),u.appendChild(g)}else{const g=document.createElement("img");g.src=E,g.alt=$||"Usuario",g.className="msg-avatar",u.appendChild(g),u.appendChild(m)}p.appendChild(u)}),f.appendChild(p),n&&!i||(f.scrollTop=f.scrollHeight)}async function k(e){const t=v.get(e);if(!t||!t.hasMore)return;const n=localStorage.getItem("token"),r=encodeURIComponent(t.oldestTs),i=await(await fetch(`${w}/chat/messages/${e}?limit=30&before=${r}`,{headers:{Authorization:`Bearer ${n}`}})).json(),p=Array.isArray(i)?i:i.messages||[];if(p.length){t.messages=[...p,...t.messages],t.oldestTs=t.messages[0].sent_date,t.hasMore=Array.isArray(i)?!1:i.hasMore;const s=f.scrollHeight;A(t,e);const c=f.scrollHeight;f.scrollTop=c-s}else t.hasMore=!1,A(t,e)}async function H(e){const t=localStorage.getItem("token");try{await fetch(`${w}/chat/read/${e}`,{method:"POST",headers:{Authorization:`Bearer ${t}`}})}catch{}}function R(e){if(!e)return;const t=_.querySelector(`.conversation-item[data-chat-id="${e}"]`);if(t){const n=t.querySelector(".unread-badge");n&&n.remove()}}
